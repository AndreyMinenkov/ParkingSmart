import React, { useState, useEffect, useRef } from 'react';
import SystemStatusBar from '../components/layout/SystemStatusBar';
import YandexMap from '../components/map/YandexMap';
import ParkingConfirmationSheet from '../components/parking/ParkingConfirmationSheet';
import BlockersScreen from './BlockersScreen';
import { parkingAPI, authAPI } from '../services/api';

const MainScreen: React.FC = () => {
  const [hasActiveParking, setHasActiveParking] = useState(false);
  const [isBlocking, setIsBlocking] = useState(false);
  const [expiresAt, setExpiresAt] = useState<string | null>(null);
  const [showParkingSheet, setShowParkingSheet] = useState(false);
  const [showBlockersScreen, setShowBlockersScreen] = useState(false);
  const [draggableMarker, setDraggableMarker] = useState<{ position: [number, number] } | null>(null);
  const [userLocation, setUserLocation] = useState<[number, number]>([55.751244, 37.618423]);
  
  const timerRef = useRef<NodeJS.Timeout | null>(null);

  useEffect(() => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const coords: [number, number] = [position.coords.latitude, position.coords.longitude];
          setUserLocation(coords);
          setDraggableMarker({ position: coords });
        },
        (error) => {
          console.error('Geolocation error:', error);
          const defaultCoords: [number, number] = [55.751244, 37.618423];
          setDraggableMarker({ position: defaultCoords });
        }
      );
    } else {
      const defaultCoords: [number, number] = [55.751244, 37.618423];
      setDraggableMarker({ position: defaultCoords });
    }
  }, []);

  // =============================================
  // Ð•Ð”Ð˜ÐÐ¡Ð¢Ð’Ð•ÐÐÐ«Ð™ Ð¢ÐÐ™ÐœÐ•Ð  â€” Ð¡Ð‘Ð ÐÐ¡Ð«Ð’ÐÐ•Ð¢Ð¡Ð¯ ÐŸÐ Ð˜ Ð›Ð®Ð‘ÐžÐœ Ð”Ð•Ð™Ð¡Ð¢Ð’Ð˜Ð˜
  // =============================================
  const resetInactivityTimer = () => {
    // Ð¡ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð°Ð½ÐµÐ»ÑŒ Ð¿Ñ€Ð¸ Ð½Ð¾Ð²Ð¾Ð¼ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¸
    setShowParkingSheet(false);
    
    // Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ Ñ‚Ð°Ð¹Ð¼ÐµÑ€
    if (timerRef.current) {
      clearTimeout(timerRef.current);
      timerRef.current = null;
    }
    
    // Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ñ‚Ð°Ð¹Ð¼ÐµÑ€ Ð½Ð° 3 ÑÐµÐºÑƒÐ½Ð´Ñ‹
    timerRef.current = setTimeout(() => {
      console.log('â° 3 ÑÐµÐºÑƒÐ½Ð´Ñ‹ Ð±ÐµÐ·Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ â€” Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð°Ð½ÐµÐ»ÑŒ Ð¿Ð°Ñ€ÐºÐ¾Ð²ÐºÐ¸');
      
      // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð°Ð½ÐµÐ»ÑŒ Ð¢ÐžÐ›Ð¬ÐšÐž ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð¼Ð°Ñ€ÐºÐµÑ€ Ð¸ Ð½ÐµÑ‚ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾Ð¹ Ð¿Ð°Ñ€ÐºÐ¾Ð²ÐºÐ¸
      if (draggableMarker && !hasActiveParking) {
        console.log('âœ… ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð°Ð½ÐµÐ»ÑŒ Ð¿Ð°Ñ€ÐºÐ¾Ð²ÐºÐ¸');
        setShowParkingSheet(true);
      } else {
        console.log('âŒ ÐÐµ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð°Ð½ÐµÐ»ÑŒ:', { 
          hasMarker: !!draggableMarker, 
          hasActiveParking 
        });
      }
      
      timerRef.current = null;
    }, 3000);
  };

  // =============================================
  // Ð”Ð•Ð™Ð¡Ð¢Ð’Ð˜Ð¯ Ð¡ ÐœÐÐ ÐšÐ•Ð ÐžÐœ
  // =============================================
  const handleMarkerUpdate = (newCoords: [number, number]) => {
    console.log('í ³ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¸ Ð¼Ð°Ñ€ÐºÐµÑ€Ð°:', newCoords);
    
    // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸ÑŽ Ð¼Ð°Ñ€ÐºÐµÑ€Ð°
    setDraggableMarker({ position: newCoords });
    
    // Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ñ‚Ð°Ð¹Ð¼ÐµÑ€ Ð±ÐµÐ·Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ
    resetInactivityTimer();
  };

  const handleMarkerDragStart = () => {
    console.log('í º©ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð¿ÐµÑ€ÐµÑ‚Ð°ÑÐºÐ¸Ð²Ð°Ð½Ð¸Ñ');
    resetInactivityTimer();
  };

  const handleMarkerDragEnd = (coords: [number, number]) => {
    console.log('í ³ÐšÐ¾Ð½ÐµÑ† Ð¿ÐµÑ€ÐµÑ‚Ð°ÑÐºÐ¸Ð²Ð°Ð½Ð¸Ñ:', coords);
    handleMarkerUpdate(coords);
  };

  const handleMapClick = (coords: [number, number]) => {
    console.log('í·ºï¸ ÐšÐ»Ð¸Ðº Ð¿Ð¾ ÐºÐ°Ñ€Ñ‚Ðµ â€” Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰Ð°ÐµÐ¼ Ð¼Ð°Ñ€ÐºÐµÑ€');
    handleMarkerUpdate(coords);
  };

  // =============================================
  // ÐžÐ¡Ð¢ÐÐ›Ð¬ÐÐ«Ð• ÐžÐ‘Ð ÐÐ‘ÐžÐ¢Ð§Ð˜ÐšÐ˜
  // =============================================
  const handleLogout = async () => {
    try {
      await authAPI.logout();
    } catch (error) {
      console.error('Logout error:', error);
    }
    localStorage.removeItem('token');
    window.location.reload();
  };

  const handleParkingConfirm = async (isBlocking: boolean) => {
    try {
      if (!draggableMarker) return;

      const response = await parkingAPI.create({
        lat: draggableMarker.position[0],
        lon: draggableMarker.position[1],
        isBlocking
      });

      setHasActiveParking(true);
      setIsBlocking(isBlocking);
      setExpiresAt(response.data.parking.expiresAt);
      setShowParkingSheet(false);
      setDraggableMarker(null);
      
      // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ñ‚Ð°Ð¹Ð¼ÐµÑ€
      if (timerRef.current) {
        clearTimeout(timerRef.current);
        timerRef.current = null;
      }
    } catch (error) {
      console.error('Parking confirm error:', error);
    }
  };

  const handleParkingClose = () => {
    setShowParkingSheet(false);
  };

  // ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ñ‚Ð°Ð¹Ð¼ÐµÑ€Ð° Ð¿Ñ€Ð¸ Ñ€Ð°Ð·Ð¼Ð¾Ð½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ð¸
  useEffect(() => {
    return () => {
      if (timerRef.current) {
        clearTimeout(timerRef.current);
        timerRef.current = null;
      }
    };
  }, []);

  return (
    <div className="h-screen flex flex-col">
      <SystemStatusBar
        isBlocking={isBlocking}
        expiresAt={expiresAt}
        onLogout={handleLogout}
      />

      <div className="flex-1 relative">
        <YandexMap
          center={userLocation}
          draggableMarker={draggableMarker}
          onMarkerDrag={handleMarkerDragEnd}
          onMarkerDragStart={handleMarkerDragStart}
          onMarkerDragEnd={handleMarkerDragEnd}
          onMapClick={handleMapClick}
        />
      </div>

      {showParkingSheet && (
        <ParkingConfirmationSheet
          onConfirm={handleParkingConfirm}
          onClose={handleParkingClose}
        />
      )}

      {showBlockersScreen && (
        <BlockersScreen
          onClose={() => setShowBlockersScreen(false)}
        />
      )}
    </div>
  );
};

export default MainScreen;
