import React, { useState, useEffect, useRef } from 'react';
import SystemStatusBar from '../components/layout/SystemStatusBar';
import YandexMap from '../components/map/YandexMap';
import ParkingConfirmationSheet from '../components/parking/ParkingConfirmationSheet';
import BlockersScreen from './BlockersScreen';
import { parkingAPI, authAPI } from '../services/api';

const MainScreen: React.FC = () => {
  const [hasActiveParking, setHasActiveParking] = useState(false);
  const [isBlocking, setIsBlocking] = useState(false);
  const [expiresAt, setExpiresAt] = useState<string | null>(null);
  const [showParkingSheet, setShowParkingSheet] = useState(false);
  const [showBlockersScreen, setShowBlockersScreen] = useState(false);
  const [draggableMarker, setDraggableMarker] = useState<{ position: [number, number] } | null>(null);
  const [userLocation, setUserLocation] = useState<[number, number]>([55.751244, 37.618423]);

  const [hasStartedInteraction, setHasStartedInteraction] = useState(false);
  const [hasEndedInteraction, setHasEndedInteraction] = useState(false);
  const timerRef = useRef<NodeJS.Timeout | null>(null);
  const isInteractionEndingRef = useRef(false);

  useEffect(() => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const coords: [number, number] = [position.coords.latitude, position.coords.longitude];
          setUserLocation(coords);
          setDraggableMarker({ position: coords });
        },
        (error) => {
          console.error('Geolocation error:', error);
          const defaultCoords: [number, number] = [55.751244, 37.618423];
          setDraggableMarker({ position: defaultCoords });
        }
      );
    } else {
      const defaultCoords: [number, number] = [55.751244, 37.618423];
      setDraggableMarker({ position: defaultCoords });
    }
  }, []);

  useEffect(() => {
    if (draggableMarker) {
      setHasStartedInteraction(false);
      setHasEndedInteraction(false);
      isInteractionEndingRef.current = false;
    }
  }, [draggableMarker]);

  useEffect(() => {
    if (draggableMarker &&
        !hasActiveParking &&
        hasStartedInteraction &&
        hasEndedInteraction &&
        !showParkingSheet) {

      console.log('âœ… Ð£ÑÐ»Ð¾Ð²Ð¸Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹: Ð½Ð°Ñ‡Ð°Ð»Ð¾ + ÐºÐ¾Ð½ÐµÑ† Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ. Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚Ð°Ð¹Ð¼ÐµÑ€ 3 ÑÐµÐºÑƒÐ½Ð´Ñ‹');

      if (timerRef.current) {
        clearTimeout(timerRef.current);
      }

      timerRef.current = setTimeout(() => {
        console.log('â° 3 ÑÐµÐºÑƒÐ½Ð´Ñ‹ Ð¿Ñ€Ð¾ÑˆÐ»Ð¸ â€” Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð°Ð½ÐµÐ»ÑŒ Ð¿Ð°Ñ€ÐºÐ¾Ð²ÐºÐ¸');
        setShowParkingSheet(true);
        timerRef.current = null;
      }, 3000);
    }

    return () => {
      if (timerRef.current) {
        clearTimeout(timerRef.current);
        timerRef.current = null;
      }
    };
  }, [draggableMarker, hasActiveParking, hasStartedInteraction, hasEndedInteraction, showParkingSheet]);

  const handleInteractionStart = () => {
    console.log('â–¶ï¸ ÐÐÐ§ÐÐ›Ðž Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ');
    setHasStartedInteraction(true);
    setHasEndedInteraction(false);
    setShowParkingSheet(false);
    isInteractionEndingRef.current = false;

    if (timerRef.current) {
      clearTimeout(timerRef.current);
      timerRef.current = null;
    }
  };

  const handleInteractionEnd = (finalCoords: [number, number]) => {
    if (isInteractionEndingRef.current) {
      console.log('â¹ï¸ ÐšÐžÐÐ•Ð¦ Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ (Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð´ÑƒÐ±Ð»ÑŒ)');
      return;
    }
    
    console.log('â¹ï¸ ÐšÐžÐÐ•Ð¦ Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ');
    isInteractionEndingRef.current = true;
    setHasEndedInteraction(true);
    
    if (draggableMarker) {
      setDraggableMarker({ position: finalCoords });
    }
  };

  const handleMarkerDragStart = () => {
    console.log('í º©ÐÐÐ§ÐÐ›Ðž Ð¿ÐµÑ€ÐµÑ‚Ð°ÑÐºÐ¸Ð²Ð°Ð½Ð¸Ñ Ð¼Ð°Ñ€ÐºÐµÑ€Ð°');
    handleInteractionStart();
  };

  const handleMarkerDragEnd = (coords: [number, number]) => {
    console.log('ï¿½ï¿½ ÐšÐžÐÐ•Ð¦ Ð¿ÐµÑ€ÐµÑ‚Ð°ÑÐºÐ¸Ð²Ð°Ð½Ð¸Ñ Ð¼Ð°Ñ€ÐºÐµÑ€Ð°:', coords);
    handleInteractionEnd(coords);
  };

  const handleMapClick = (coords: [number, number]) => {
    console.log('í·ºï¸ ÐšÐ»Ð¸Ðº Ð¿Ð¾ ÐºÐ°Ñ€Ñ‚Ðµ â€” Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰Ð°ÐµÐ¼ Ð¼Ð°Ñ€ÐºÐµÑ€ Ð¸ Ð·Ð°Ð²ÐµÑ€ÑˆÐ°ÐµÐ¼ Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ');
    
    // 1. Ð¡ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð°Ð½ÐµÐ»ÑŒ ÐµÑÐ»Ð¸ Ð±Ñ‹Ð»Ð° Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð°
    setShowParkingSheet(false);
    
    // 2. Ð•ÑÐ»Ð¸ ÑÑ‚Ð¾ ÐŸÐ•Ð Ð’ÐžÐ• Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ â€” Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÐ¼
    if (!hasStartedInteraction) {
      handleInteractionStart();
    }
    
    // 3. ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸ÑŽ Ð¼Ð°Ñ€ÐºÐµÑ€Ð°
    if (draggableMarker) {
      setDraggableMarker({ position: coords });
    }
    
    // 4. **Ð’ÐÐ–ÐÐž**: Ð—Ð°Ð²ÐµÑ€ÑˆÐ°ÐµÐ¼ Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ (Ñ‚Ð°Ð¹Ð¼ÐµÑ€ Ð¿Ð¾Ð¹Ð´Ñ‘Ñ‚)
    handleInteractionEnd(coords);
  };

  const handleLogout = async () => {
    try {
      await authAPI.logout();
    } catch (error) {
      console.error('Logout error:', error);
    }
    localStorage.removeItem('token');
    window.location.reload();
  };

  const handleParkingConfirm = async (isBlocking: boolean) => {
    try {
      if (!draggableMarker) return;

      const response = await parkingAPI.create({
        lat: draggableMarker.position[0],
        lon: draggableMarker.position[1],
        isBlocking
      });

      setHasActiveParking(true);
      setIsBlocking(isBlocking);
      setExpiresAt(response.data.parking.expiresAt);
      setShowParkingSheet(false);
      setDraggableMarker(null);
      setHasStartedInteraction(false);
      setHasEndedInteraction(false);
      isInteractionEndingRef.current = false;
    } catch (error) {
      console.error('Parking confirm error:', error);
    }
  };

  const handleParkingClose = () => {
    setShowParkingSheet(false);
  };

  return (
    <div className="h-screen flex flex-col">
      <SystemStatusBar
        isBlocking={isBlocking}
        expiresAt={expiresAt}
        onLogout={handleLogout}
      />

      <div className="flex-1 relative">
        <YandexMap
          center={userLocation}
          draggableMarker={draggableMarker}
          onMarkerDrag={handleMarkerDragEnd}
          onMarkerDragStart={handleMarkerDragStart}
          onMarkerDragEnd={handleMarkerDragEnd}
          onMapClick={handleMapClick}
        />
      </div>

      {showParkingSheet && (
        <ParkingConfirmationSheet
          onConfirm={handleParkingConfirm}
          onClose={handleParkingClose}
        />
      )}

      {showBlockersScreen && (
        <BlockersScreen
          onClose={() => setShowBlockersScreen(false)}
        />
      )}
    </div>
  );
};

export default MainScreen;
